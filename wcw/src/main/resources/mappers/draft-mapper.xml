<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="draftMapper">

<!-- 직원 리스트 select -->
<select id="selectEmployee" parameterType="_int" resultType="Employee">
	SELECT e.emp_no, e.email, e.pwd, e.name, e.intl_no, e.phone, e.sign, e.join_date, d.dept_no, d.dept_name, j.job_title_no, j.job_title, j.job_level
	FROM TB_EMPLOYEE e
		JOIN TB_DEPARTMENT d on e.dept_no = d.dept_no
		JOIN TB_COMPANY c on d.cp_no = c.cp_no
		JOIN TB_JOB_TITLE j on j.job_title_no = e.job_title_no
    where resign_yn = 'N' and c.cp_no = #{cp_no}
    order by job_level desc, name
</select>

<!-- 기안 insert -->
<insert id="insertDraft" parameterType="hashmap">
	insert all
		
		<if test='dr_sort == 1'> 
			into tb_draft (dr_no, ep_no, dr_sort, dr_result, dr_title, dr_content, dr_purpose, dr_date, dr_due_date, dr_comment) 
			values ((select nvl(max(dr_no),99)+1 from tb_draft), 
					#{ep_no}, #{dr_sort}, default, #{dr_title}, #{dr_content}, #{dr_purpose}, default, (SELECT (sysdate+14) FROM dual), #{dr_comment})
		</if>
		
		<if test='dr_sort == 2'> 
			into tb_draft (dr_no, ep_no, dr_sort, dr_result, dr_title, dr_content, dr_date, dr_due_date, dr_comment, dr_expect_date) 
			values ((select nvl(max(dr_no),99)+1 from tb_draft),
					#{ep_no}, #{dr_sort}, default, #{dr_title}, #{dr_content}, default, (SELECT (sysdate+14) FROM dual), #{dr_comment}, #{dr_expect_date})
		</if>
		
		<if test='dr_sort == 3'> 
			into tb_draft (dr_no, 
							ep_no, dr_sort, dr_result, dr_title, dr_content, dr_date, dr_due_date) 
			values ((select nvl(max(dr_no),99)+1 from tb_draft),
					#{ep_no}, #{dr_sort}, default, #{dr_title}, #{dr_content}, default, (SELECT (sysdate+14) FROM dual))
			
			into tb_spend (dr_no, spend_date, spend_purpose, spend_content, spend_amount, spend_content_prvt, spend_amount_prvt, spend_sum)
			values ((select nvl(max(dr_no),99)+1 from tb_draft),
					#{spend_date}, #{spend_purpose}, #{spend_content}, #{spend_amount}, #{spend_content_prvt}, #{spend_amount_prvt}, #{spend_sum})
		</if>
		
			into tb_approval (appr_no, dr_no, emp_no, appr_order, appr_result)
			values ((select nvl(max(appr_no),0)+1 from tb_approval),
					(select nvl(max(dr_no),99)+1 from tb_draft),
					#{emp_no_1}, 1, 3)
					
		<if test='emp_no_2 != "" and !emp_no_2.equals("")'>
			into tb_approval (appr_no, dr_no, emp_no, appr_order, appr_result)
			values ((select nvl(max(appr_no),0)+2 from tb_approval),
					(select nvl(max(dr_no),99)+1 from tb_draft),
					#{emp_no_2}, 2, 4)
		</if>	
		<if test='emp_no_3 != "" and !emp_no_3.equals("")'>
			into tb_approval (appr_no, dr_no, emp_no, appr_order, appr_result)
			values ((select nvl(max(appr_no),0)+3 from tb_approval),
					(select nvl(max(dr_no),99)+1 from tb_draft),
					#{emp_no_3}, 3, 4)
		</if>		
	
	select * from dual
</insert>

<select id="selectListDraft" parameterType="_int" resultType="Draft">
	select dr_no, dr_sort, dr_title, dr_date, dr_due_date, dr_result
	from tb_draft
	where ep_no = #{ep_no}
</select>

</mapper>